
<!DOCTYPE html>
<html>

<!-- 
	Generator barkod uplatnica. Kod preuzet i (donekle) izmjenjen:
	https://bikonja.github.io/generator-barkoda-uplatnica/
-->

<head>
	<meta charset="UTF-8">
	<title>Generator barkoda uplatnica</title>
	<script src="https://code.jquery.com/jquery-latest.min.js"></script>
	<script src="./bcmath-min.js"></script>
	<script src="./pdf417-min.js"></script>
	<script src="./BarcodePayment.js"></script>
</head>
<body>

<script type="text/javascript">

	jQuery(document).ready(function() {
		BarcodePayment.Init({
			ValidateIBAN: false, // Validation is not yet implemented
			ValidateModelPozivNaBroj: true // Validation is not yet implemented
		});
		GenerirajBarkod();
	});

	function getPaymentParams() {
		const paymentParams = new BarcodePayment.PaymentParams();
		const urlParams = new URLSearchParams(window.location.search);
	
		const queryIznos = urlParams.get('iznos');
		const queryRacunPrimatelja = urlParams.get('racunprimatelja');
		const queryModelPlacanja = urlParams.get('modelplacanja');
		const queryPozivNaBroj = urlParams.get('pozivnabroj');
		const queryOpisPlacanja = urlParams.get('opisplacanja');
		const querySifraNamjene = urlParams.get('sifranamjene');
		const queryImeIPrezimePlatitelja = urlParams.get('imeiprezimeplatitelja');
		const queryAdresaPlatitelja = urlParams.get('adresaplatitelja');
		const queryPostanskiBrojIMjestoPlatitelja = urlParams.get('postanskibrojimjestoplatitelja');
		const queryPrimatelj = urlParams.get('primatelj');
		const queryAdresaPrimatelja = urlParams.get('adresaprimatelja');
		const queryPostanskiBrojIMjestoPrimatelja = urlParams.get('postanskibrojimjestoprimatelja');

		function appendIfNotNull(name, value) {
			if (name && value) paymentParams[name] = value;
		}

		appendIfNotNull('Iznos', queryIznos);
		appendIfNotNull('ImePlatitelja', queryImeIPrezimePlatitelja);
		appendIfNotNull('AdresaPlatitelja', queryAdresaPlatitelja);
		appendIfNotNull('SjedistePlatitelja', queryPostanskiBrojIMjestoPlatitelja);
		appendIfNotNull('Primatelj', queryPrimatelj);
		appendIfNotNull('AdresaPrimatelja', queryAdresaPrimatelja);
		appendIfNotNull('SjedistePrimatelja', queryPostanskiBrojIMjestoPrimatelja);
		appendIfNotNull('IBAN', queryRacunPrimatelja);
		appendIfNotNull('ModelPlacanja', queryModelPlacanja);
		appendIfNotNull('PozivNaBroj', queryPozivNaBroj);
		appendIfNotNull('SifraNamjene', querySifraNamjene);
		appendIfNotNull('OpisPlacanja', queryOpisPlacanja);
		
		return paymentParams;
	}

	function HandleValidation(paymentParams) {
		var result = BarcodePayment.ValidatePaymentParams(paymentParams);
		// TODO: result is BarcodePayment.ValidationResult, check which validations failed and display appropriate messages
	}
	
	var StringNotDefinedOrEmpty = function(str) {
		return str == undefined || str == null || str.length == 0;
	}
	
	function GenerirajBarkod() {
		var generateBarcode = true;
		var paymentParams = getPaymentParams();
		var textToEncode = BarcodePayment.GetEncodedText(paymentParams);
		
		if (textToEncode == BarcodePayment.ResultCode.InvalidContent) {
			HandleValidation(paymentParams);
			generateBarcode = false;
			// alert('Sadržaj forme nije ispravan za generiranja barkoda');
		} else if (textToEncode == BarcodePayment.ResultCode.InvalidObject || StringNotDefinedOrEmpty(textToEncode)) {
			// alert('Došlo je do greške kod generiranja barkoda');
			generateBarcode = false;
		} 
		
		// Barcode generation sample copied from library sample
		PDF417.init(textToEncode);
		const barcode = PDF417.getBarcodeArray();
		// block sizes (width and height) in pixels
		const bw = 2;
		const bh = 2;
		// create canvas element based on number of columns and rows in barcode
		const container = document.getElementById('barcode');
		if (container.firstChild) {
			container.removeChild(container.firstChild);
		}
		const canvas = document.createElement('canvas');
		canvas.width = bw * barcode['num_cols'];
		canvas.height = bh * barcode['num_rows'];

		if (generateBarcode) {
			const context = canvas.getContext('2d');
			// graph barcode elements
			let y = 0;
			// for each row
			for (let r = 0; r < barcode['num_rows']; ++r) {
				let x = 0;
				// for each column
				for (var c = 0; c < barcode['num_cols']; ++c) {
					if (barcode['bcode'][r][c] == 1) {
						context.fillStyle = "#000";
						context.fillRect(x, y, bw, bh);
					}
					else {
						context.fillStyle = "#FFF";
						context.fillRect(x, y, bw, bh);
					}
					x += bw;
				}
				y += bh;
			}
			const barcodeImage = new Image();
			barcodeImage.src = canvas.toDataURL('image/jpeg');
			container.appendChild(barcodeImage);
		}
	}
	</script>
	<div id="barcode"></div>
</body>
</html>